@page "/"
@using ImmoCalc.Stores.ProjectList
@using ImmoCalc.Stores.CurrentProject
@using ImmoCalc.Domain
@inherits BlazorState.BlazorStateComponent
@inject NavigationManager Navigation;

<ion-header translucent>
    <ion-toolbar mode="ios">
        <ion-title>Mes projets</ion-title>
    </ion-toolbar>
</ion-header>

<ion-content>

    @if (State.ProjectListLoading) {
        <ion-list>
            @for (int i = 0; i < 10; i++) {
                <ion-item-sliding>
                    <ion-item detail button>
                        <ion-thumbnail slot="start" style="width: 32px; height: 32px;">
                            <ion-skeleton-text animated></ion-skeleton-text>
                        </ion-thumbnail>
                        <ion-label>
                            <h2><ion-skeleton-text animated style="width: 35%"></ion-skeleton-text></h2>
                            <h3><ion-skeleton-text animated style="width: 70%"></ion-skeleton-text></h3>
                        </ion-label>
                    </ion-item>
                </ion-item-sliding>
            }
        </ion-list>
    }
    else {
        <IonRefresher OnRefresh="Load"></IonRefresher>
        <ion-list>
            @foreach (var project in State.ProjectList) {
                <ion-item-sliding>
                    <ion-item detail button @onclick="@(() => ListItemClicked(project.Id))">
                        <ion-icon slot="start" name="home-outline"></ion-icon>
                        <ion-label>
                            <h2>@project.Label</h2>
                            <h3>@project.Address</h3>
                        </ion-label>
                    </ion-item>
                    <ion-item-options side="end">
                        <ion-item-option color="danger" @onclick="@(()=>Remove(project.Id))">Remove</ion-item-option>
                    </ion-item-options>
                </ion-item-sliding>
            }
        </ion-list>
    }

    <ion-fab slot="fixed" vertical="bottom" horizontal="end">
        <ion-fab-button @onclick="@CreateNewItemClicked">
            <ion-icon name="add"></ion-icon>
        </ion-fab-button>
    </ion-fab>
</ion-content>

@code
{
    private ProjectListState State => GetState<ProjectListState>();

    private async Task ListItemClicked(Guid projectId) {
        Navigation.NavigateTo("simulator");
        await Mediator.Send(new CurrentProjectState.Load(ProjectId.From(projectId)));
    }

    private void CreateNewItemClicked()
    {
        Mediator.Send(new CurrentProjectState.CreateNewProject());
        Navigation.NavigateTo("simulator");
    }

    private async Task Remove(Guid projectId)
{
        await Mediator.Send(new ProjectListState.RemoveProject(ProjectId.From(projectId)));
    }

    protected override void OnInitialized()
    {
        Subscriptions.Add<ProjectListState>(this);
        base.OnInitialized();
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
            await Mediator.Send(new ProjectListState.LoadProjectList(true));

        await base.OnAfterRenderAsync(firstRender);
    }

    private async Task Load()
    {
        await Mediator.Send(new ProjectListState.LoadProjectList());
    }
}

